#!/usr/bin/env bash
##
##  So many years of fooling around...
##
##


[ -e $f ] && rm -rf $HISTFILE


function dynamic_aliases {
  if sed --version >&/dev/null 2>&1
  then  # GNU sed
    rsed="sed -r"
  else  # BSD sed
    rsed="sed -E"
  fi
  if ls --version >&/dev/null 2>&1
  then  # GNU ls
    alias l='ls --color'
    alias ll='ls -lA --color'
  else  # BSD ls
    alias l='ls -G'
    alias ll='ls -GlA'
  fi
}

dynamic_aliases

for d in /etc /usr/local/etc /opt/local/etc
do
  [ -f $d/bash_completion ] && source $d/bash_completion
done



## begin prompt #######################################################

DARK="\[\e[01;34m\]"
NORM="\[\e[01;32m\]"
FADE="\[\e[01;30m\]"
REST="\[\e[00;00m\]"
HIGH="\[\e[01;33m\]"

function cutter {
  $rsed "s/(.{$1})..+.(.{$2})/\1...\2/"
}

function escape_nl {
  $rsed -n '1 { x ;} ; 2,$ { H ; x ; s/\n/^J/ ; x ;} ; $ { x ; p ;}'
}

function dir {
  pwd -P | escape_nl | cat -t | cutter 19 18 # At most 40 chars.
}

function host {
  hostname | cutter 9 8  # At most 20 chars.
}

function user {
  whoami | cutter 7 6   # At most 16 chars.
}

function pretty_prompt {
  local gray='setaf 0'
  local blue='setaf 4'
  local green='setaf 2'
  local red='setaf 1'
  local -A s=( [user]=$(user) [host]=$(host) [dir]=$(dir) )
  local rfill=80
  local buff=""
  local component=""
  buff="$buff""$(tput bold)""$(tput $blue)"
  buff="$buff""# "                   ;  let "rfill-=2"
  buff="$buff""$([[ ${s[user]} = root ]] && tput $red)"
  buff="$buff""${s[user]}"           ;  let "rfill-=${#s[user]}"
  buff="$buff""$(tput $gray)"
  buff="$buff"'@'                    ;  let "rfill-=1"
  buff="$buff""$(tput $blue)"
  buff="$buff""${s[host]}"           ;  let "rfill-=${#s[host]}"
  buff="$buff""$(tput $gray)"
  buff="$buff"':'                    ;  let "rfill-=1"
  buff="$buff""$(tput $green)"
  while read -r -d/ component
  do
    buff="$buff""$(tput $green)"
    buff="$buff""$component"         ;  let "rfill-=${#component}"
    case "$?" in
      0)  buff="$buff""$(tput $gray)"
          buff="$buff"'/'            ;  let "rfill-=1" ;;
    esac
  done <<<"${s[dir]}"
  buff="$buff""$(tput $green)"
  buff="$buff""$component"           ;  let "rfill-=${#component}"
  for space in $(seq 1 $rfill)
  do
    buff="$buff"' '
  done
  echo "$buff"
}


export          PROMPT_COMMAND=pretty_prompt
export          PS1="$DARK:$FADE;  $REST"
export          PS2='  '

## end prompt #########################################################


##if which vimpager >&/dev/null
##then
##  export        PAGER=vimpager
##  export        MANPAGER=vimmanpager
##fi
export          EDITOR=vim
export          TEXEDIT="${EDITOR} +%d %s"
export          PATH=$PATH:/sbin/:/usr/sbin/:$HOME/bin:./bin:.

alias           go='pushd'
alias           b='popd'
alias           h='history'
alias           r='rm -r'
alias           :x='exit'
alias           :q='exit'
alias           :e=$EDITOR

set -o vi


